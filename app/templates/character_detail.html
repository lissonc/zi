{% extends 'base.html' %}

{% block content %}
<div class="mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('main.characters') }}">Characters</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ character.hanzi }}</li>
        </ol>
    </nav>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="character-detail mb-4">
            <div class="row">
                <div class="col-md-4 text-center">
                    <div class="hanzi-large">{{ character.hanzi }}</div>
                    {% if character.traditional %}
                    <p class="text-muted">Traditional: {{ character.traditional }}</p>
                    {% endif %}
                </div>
                <div class="col-md-8">
                    <h2 class="mb-3">{{ character.keyword }}</h2>
                    <div class="mb-3">
                        <span class="badge bg-primary me-2">Heisig Index: {{ character.heisig_index }}</span>
                        {% if character.strokes %}
                        <span class="badge bg-secondary me-2">Strokes: {{ character.strokes }}</span>
                        {% endif %}
                        {% if character.pinyin %}
                        <span class="badge bg-info me-2">Pinyin: {{ character.pinyin }}</span>
                        {% endif %}
                    </div>
                    
                    {% if character.primitives %}
                    <div class="character-primitives">
                        <h5>Primitives:</h5>
                        <div>
                            {% for primitive in character.primitives %}
                            <a href="{{ url_for('main.primitive_detail', id=primitive.id) }}" class="primitive-tag">
                                <span class="hanzi-small me-1">{{ primitive.symbol }}</span> {{ primitive.name }}
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            {% if character.story %}
            <div class="mt-4">
                <h5>Mnemonic Story:</h5>
                <div class="card">
                    <div class="card-body">
                        {{ character.story|nl2br }}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Character Graph</h5>
            </div>
            <div class="card-body">
                <div id="mini-graph-container" style="height: 300px;"></div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Character Information</h5>
            </div>
            <div class="card-body">
                <table class="table">
                    <tbody>
                        <tr>
                            <th>Heisig Index:</th>
                            <td>{{ character.heisig_index }}</td>
                        </tr>
                        {% if character.strokes %}
                        <tr>
                            <th>Stroke Count:</th>
                            <td>{{ character.strokes }}</td>
                        </tr>
                        {% endif %}
                        {% if character.pinyin %}
                        <tr>
                            <th>Pinyin:</th>
                            <td>{{ character.pinyin }}</td>
                        </tr>
                        {% endif %}
                        {% if character.traditional %}
                        <tr>
                            <th>Traditional Form:</th>
                            <td>{{ character.traditional }}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <th>Added:</th>
                            <td>{{ character.date_added.strftime('%Y-%m-%d') }}</td>
                        </tr>
                        <tr>
                            <th>Last Modified:</th>
                            <td>{{ character.date_modified.strftime('%Y-%m-%d') }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        {% if current_user.is_authenticated and current_user.is_admin %}
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Admin Actions</h5>
            </div>
            <div class="card-body">
                <a href="{{ url_for('dashboard.edit_character', id=character.id) }}" class="btn btn-primary mb-2 w-100">
                    <i class="fas fa-edit me-2"></i>Edit Character
                </a>
                <form action="{{ url_for('dashboard.delete_character', id=character.id) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this character?');">
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="fas fa-trash me-2"></i>Delete Character
                    </button>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Include vis.js network library -->
<script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.2/dist/vis-network.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Create a mini graph for this character only
        fetch('/api/graph-data')
            .then(response => response.json())
            .then(data => {
                // Filter for this character and its immediate connections
                const characterNodeId = 'c_{{ character.id }}';
                const relatedNodeIds = new Set();
                
                // Find connected nodes
                data.edges.forEach(edge => {
                    if (edge.from === characterNodeId || edge.to === characterNodeId) {
                        relatedNodeIds.add(edge.from);
                        relatedNodeIds.add(edge.to);
                    }
                });
                
                // Filter nodes
                const filteredNodes = data.nodes.filter(node => relatedNodeIds.has(node.id));
                
                // Filter edges
                const filteredEdges = data.edges.filter(edge => 
                    relatedNodeIds.has(edge.from) && relatedNodeIds.has(edge.to)
                );
                
                // Create mini graph
                const container = document.getElementById('mini-graph-container');
                const filteredData = {
                    nodes: filteredNodes,
                    edges: filteredEdges
                };
                
                // Configuration for the network
                const options = {
                    nodes: {
                        shape: 'circle',
                        font: {
                            size: 18,
                            face: 'Arial',
                            color: '#ffffff'
                        },
                        borderWidth: 2
                    },
                    edges: {
                        width: 1,
                        arrows: {
                            to: { enabled: true, scaleFactor: 0.5 }
                        }
                    },
                    physics: {
                        stabilization: true,
                        barnesHut: {
                            gravitationalConstant: -2000,
                            springConstant: 0.04,
                            springLength: 100
                        }
                    }
                };
                
                // Create the network
                const network = new vis.Network(container, filteredData, options);
                
                // Highlight the current character
                network.on("afterDrawing", function() {
                    network.selectNodes([characterNodeId]);
                });
                
                // Add click event to navigate to other nodes
                network.on("click", function(params) {
                    if (params.nodes.length > 0) {
                        const nodeId = params.nodes[0];
                        if (nodeId !== characterNodeId) {
                            const nodeType = nodeId.startsWith('c_') ? 'characters' : 'primitives';
                            const realId = nodeId.substr(2); // Remove the prefix
                            
                            // Navigate to the detail page
                            window.location.href = `/${nodeType}/${realId}`;
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error loading graph data:', error);
                document.getElementById('mini-graph-container').innerHTML = 
                    '<div class="alert alert-danger">Error loading graph data.</div>';
            });
    });
</script>
{% endblock %} 