{% extends 'base.html' %}

{% block content %}
<div class="mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('main.primitives') }}">Primitives</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ primitive.name }}</li>
        </ol>
    </nav>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="character-detail mb-4">
            <div class="row">
                <div class="col-md-4 text-center">
                    <div class="hanzi-large">{{ primitive.symbol }}</div>
                </div>
                <div class="col-md-8">
                    <h2 class="mb-3">{{ primitive.name }}</h2>
                    {% if primitive.meaning %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Meaning</h5>
                        </div>
                        <div class="card-body">
                            {{ primitive.meaning|nl2br }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Characters using this primitive -->
        {% if primitive.characters.count() > 0 %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Characters Using This Primitive</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for character in primitive.characters.all() %}
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="character-card">
                            <div class="d-flex align-items-center">
                                <div class="hanzi-medium me-3">{{ character.hanzi }}</div>
                                <div>
                                    <h5 class="mb-1">{{ character.keyword }}</h5>
                                    <p class="mb-1 text-muted">Heisig Index: {{ character.heisig_index }}</p>
                                    <a href="{{ url_for('main.character_detail', id=character.id) }}" class="btn btn-sm btn-outline-primary mt-2">Details</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info">
            <p class="mb-0">No characters are currently using this primitive.</p>
        </div>
        {% endif %}
    </div>
    
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Primitive Information</h5>
            </div>
            <div class="card-body">
                <table class="table">
                    <tbody>
                        <tr>
                            <th>Name:</th>
                            <td>{{ primitive.name }}</td>
                        </tr>
                        <tr>
                            <th>Symbol:</th>
                            <td class="hanzi-small">{{ primitive.symbol }}</td>
                        </tr>
                        <tr>
                            <th>Characters:</th>
                            <td>{{ primitive.characters.count() }}</td>
                        </tr>
                        <tr>
                            <th>Added:</th>
                            <td>{{ primitive.date_added.strftime('%Y-%m-%d') }}</td>
                        </tr>
                        <tr>
                            <th>Last Modified:</th>
                            <td>{{ primitive.date_modified.strftime('%Y-%m-%d') }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Primitive Graph</h5>
            </div>
            <div class="card-body">
                <div id="mini-graph-container" style="height: 300px;"></div>
            </div>
        </div>
        
        {% if current_user.is_authenticated and current_user.is_admin %}
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Admin Actions</h5>
            </div>
            <div class="card-body">
                <a href="{{ url_for('dashboard.edit_primitive', id=primitive.id) }}" class="btn btn-primary mb-2 w-100">
                    <i class="fas fa-edit me-2"></i>Edit Primitive
                </a>
                <form action="{{ url_for('dashboard.delete_primitive', id=primitive.id) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this primitive?');">
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="fas fa-trash me-2"></i>Delete Primitive
                    </button>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Include vis.js network library -->
<script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.2/dist/vis-network.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Create a mini graph for this primitive only
        fetch('/api/graph-data')
            .then(response => response.json())
            .then(data => {
                // Filter for this primitive and its immediate connections
                const primitiveNodeId = 'p_{{ primitive.id }}';
                const relatedNodeIds = new Set();
                
                // Find connected nodes
                data.edges.forEach(edge => {
                    if (edge.from === primitiveNodeId || edge.to === primitiveNodeId) {
                        relatedNodeIds.add(edge.from);
                        relatedNodeIds.add(edge.to);
                    }
                });
                
                // Filter nodes
                const filteredNodes = data.nodes.filter(node => relatedNodeIds.has(node.id));
                
                // Filter edges
                const filteredEdges = data.edges.filter(edge => 
                    relatedNodeIds.has(edge.from) && relatedNodeIds.has(edge.to)
                );
                
                // Create mini graph
                const container = document.getElementById('mini-graph-container');
                const filteredData = {
                    nodes: filteredNodes,
                    edges: filteredEdges
                };
                
                // Configuration for the network
                const options = {
                    nodes: {
                        shape: 'circle',
                        font: {
                            size: 18,
                            face: 'Arial',
                            color: '#ffffff'
                        },
                        borderWidth: 2
                    },
                    edges: {
                        width: 1,
                        arrows: {
                            to: { enabled: true, scaleFactor: 0.5 }
                        }
                    },
                    physics: {
                        stabilization: true,
                        barnesHut: {
                            gravitationalConstant: -2000,
                            springConstant: 0.04,
                            springLength: 100
                        }
                    }
                };
                
                // Create the network
                const network = new vis.Network(container, filteredData, options);
                
                // Highlight the current primitive
                network.on("afterDrawing", function() {
                    network.selectNodes([primitiveNodeId]);
                });
                
                // Add click event to navigate to other nodes
                network.on("click", function(params) {
                    if (params.nodes.length > 0) {
                        const nodeId = params.nodes[0];
                        if (nodeId !== primitiveNodeId) {
                            const nodeType = nodeId.startsWith('c_') ? 'characters' : 'primitives';
                            const realId = nodeId.substr(2); // Remove the prefix
                            
                            // Navigate to the detail page
                            window.location.href = `/${nodeType}/${realId}`;
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error loading graph data:', error);
                document.getElementById('mini-graph-container').innerHTML = 
                    '<div class="alert alert-danger">Error loading graph data.</div>';
            });
    });
</script>
{% endblock %} 